<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Guardián - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #121212; color: #f1f1f1; padding: 20px; }
        h1 { color: #00ff99; margin-bottom: 20px; }
        table { margin-top: 20px; }
    </style>
</head>
<body>

<div class="container">
    <h1>Guardián - Dashboard</h1>

    <div class="mb-3">
        <label>Rango de red (ej: 192.168.0.0/24):</label>
        <input type="text" id="network_range" class="form-control" placeholder="192.168.0.0/24">
    </div>

    <div class="mb-3">
        <button class="btn btn-success" onclick="getScan()">Escanear Red</button>
        <button class="btn btn-warning" onclick="getAlerts()">Ver Alertas</button>
        <button class="btn btn-danger" onclick="clearAlerts()">Limpiar Alertas</button>
    </div>

    <h2>Dispositivos Conectados</h2>
    <table class="table table-dark table-striped" id="devices">
        <tr><th>IP</th><th>MAC</th></tr>
    </table>

    <h2>Alertas</h2>
    <table class="table table-dark table-striped" id="alerts">
        <tr><th>ID</th><th>Tipo</th><th>Hora</th><th>Descripción</th></tr>
    </table>

    <h2>Agregar a Whitelist</h2>
    <form onsubmit="addToWhitelist(); return false;">
        <div class="mb-3">
            <label>Nombre del dispositivo:</label>
            <input type="text" id="device_name" class="form-control" required>
        </div>
        <div class="mb-3">
            <label>MAC:</label>
            <input type="text" id="device_mac" class="form-control" required>
        </div>
        <div class="mb-3">
            <label>IP:</label>
            <input type="text" id="device_ip" class="form-control" required>
        </div>
        <button type="submit" class="btn btn-primary">Agregar</button>
    </form>

</div>

<script>
async function getScan() {
    const range = document.getElementById('network_range').value || "192.168.0.0/24";

    const res = await fetch('/scan/?network_range=' + encodeURIComponent(range));
    const data = await res.json();
    const table = document.getElementById('devices');
    table.innerHTML = "<tr><th>IP</th><th>MAC</th></tr>";
    data.dispositivos_detectados.forEach(d => {
        table.innerHTML += `<tr><td>${d.ip}</td><td>${d.mac}</td></tr>`;
    });
}

async function getAlerts() {
    const res = await fetch('/alerts/');
    const data = await res.json();
    const table = document.getElementById('alerts');
    table.innerHTML = "<tr><th>ID</th><th>Tipo</th><th>Hora</th><th>Descripción</th></tr>";
    data.forEach(a => {
        table.innerHTML += `<tr><td>${a.id}</td><td>${a.type}</td><td>${a.timestamp}</td><td>${a.description}</td></tr>`;
    });
}

async function clearAlerts() {
    if (confirm("¿Seguro que querés eliminar todas las alertas?")) {
        await fetch('/alerts/clear', { method: 'DELETE' });
        alert("Alertas eliminadas");
        getAlerts();
    }
}

async function addToWhitelist() {
    const name = document.getElementById('device_name').value;
    const mac = document.getElementById('device_mac').value;
    const ip = document.getElementById('device_ip').value;

    const data = { name: name, mac: mac, ip: ip };

    const res = await fetch('/whitelist/add', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    });

    if (res.ok) {
        alert("Dispositivo agregado a la whitelist");
        document.getElementById('device_name').value = "";
        document.getElementById('device_mac').value = "";
        document.getElementById('device_ip').value = "";
    } else {
        alert("Error al agregar a whitelist");
    }
}
</script>

</body>
</html>
